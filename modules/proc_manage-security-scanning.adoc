[[quay-security-scanner]]
= {productname} Security Scanning with Clair

{productname} supports scanning container images for known
vulnerabilities with a scanning engine such as link:https://github.com/coreos/clair/[Clair].
This document explains how to configure Clair with {productname}.

[id='visit-the-management-panel_{context}']
== Visit {productname} Setup

To enable Clair security scanning in {productname}, whether at deployment time or
on a running {productname} cluster, you need to start the quay container in
config mode. Enabling Clair is done in the Security Scanner section of the {productname} Setup screen, shown here:

image:../../images/security-scanner-enabled.png[Configure Clair from the {productname} config tool]

There are different procedures for configuring Clair for {productname} on OpenShift or
other environments (i.e. directly on a host, with `docker` or `podman`), as described in the following sections.

[[enable-security-scanning-openshift]]
== Enable Clair in {productname} on OpenShift deployments
To deploy Clair on OpenShift, see link:https://access.redhat.com/documentation/en-us/red_hat_quay/3/html-single/deploy_red_hat_quay_on_openshift/index#add-clair-scanner[Adding Clair image scanning to {productname}].

[[enable-security-scanning-host]]
== Enable Clair in other {productname} deployments
To deploy Clair on basic and high availability deployments (non-OpenShift),
you need to:

* Set up Clair in the {productname} config tool to enable security scanning and create a key and pem file.
* Start up the Clair service and associated database.

=== Set up Clair in the {productname} config tool

. **Restart the {productname} config tool**: Run the quay container again in config mode,
open the configuration UI in a browser, then select `Modify an existing configuration`.
When prompted, upload the `quay-config.tar.gz` file.

. **Enable Security Scanning**: Scroll to the Security Scanner section and
select the "Enable Security Scanning" checkbox. From the fields that appear you need to create an
authentication key and enter the security scanner endpoint. Here's how:
+
* **Generate key**: Click `Create Key`, then from the pop-up window
type a name for the Clair private key
and an optional expiration date (if blank, the key
never expires). Then select Generate Key.
* **Copy the Clair key and PEM file**: Save the Key ID (to a notepad or similar)
and download a copy of the Private Key PEM file (`named security_scanner.pem`)
by selecting "Download Private Key"
(if you lose the key, you need to generate a new one). You will need the key and PEM file when you
start the Clair container later.
+
Close the pop-up when you are done.
Here is an example of a completed Security Scanner config:
+
image:../../images/security-scanner-enabled.png[Create authentication key and set scan endpoint]
. **Save the configuration**: Click `Save Configuration Changes` and then select `Download Configuration`
to save it to your local system.
. *Copy config.yaml to config directory*: To pick up the changes enabling scanning, as well as other
changes you may have made to the configuration, unpack the `quay-config.tar.gz` and copy the resulting
files to the config directory. For example:
+
....
$ tar xvf quay-config.tar.gz
config.yaml  ssl.cert  ssl.key
$ cp config.yaml ssl* /mnt/quay/config
....

Next, start the Clair container and associated database, as described in the following sections.
